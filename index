<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#f2f2f7">
<meta name="description" content="NavGuard - × ×™×•×•×˜ ×—×™×¨×•× ×¢× ××™×§×•× ×¨×‘-××§×•×¨×•×ª. ×¢×•×‘×“ ×’× ×›×©×”-GPS ××•×¤×¨×¢.">
<title>NavGuard - × ×™×•×•×˜ ×—×™×¨×•×</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Secular+One&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NavGuard â€” iOS-Inspired Premium Design
   By Roie Zukerman
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}

:root{
  --bg:#f2f2f7;
  --card:rgba(255,255,255,0.88);
  --card-solid:#ffffff;
  --card-hover:rgba(255,255,255,0.95);
  --text:#1c1c1e;
  --text2:#3a3a3c;
  --text3:#8e8e93;
  --text4:#aeaeb2;
  --sep:rgba(60,60,67,0.08);
  --sep-heavy:rgba(60,60,67,0.18);
  --blue:#007aff;
  --blue-light:rgba(0,122,255,0.1);
  --blue-glow:rgba(0,122,255,0.25);
  --green:#34c759;
  --green-light:rgba(52,199,89,0.1);
  --orange:#ff9500;
  --orange-light:rgba(255,149,0,0.1);
  --red:#ff3b30;
  --red-light:rgba(255,59,48,0.1);
  --radius:18px;
  --radius-md:14px;
  --radius-sm:10px;
  --blur:saturate(180%) blur(20px);
  --blur-heavy:saturate(200%) blur(40px);
  --shadow-sm:0 1px 3px rgba(0,0,0,0.04),0 1px 2px rgba(0,0,0,0.02);
  --shadow-md:0 4px 20px rgba(0,0,0,0.06),0 1px 3px rgba(0,0,0,0.04);
  --shadow-lg:0 8px 40px rgba(0,0,0,0.08),0 2px 8px rgba(0,0,0,0.04);
  --safe-bottom:max(env(safe-area-inset-bottom,0px),12px);
}

html,body{height:100%;width:100%;overflow:hidden;position:fixed;top:0;left:0}
body{font-family:'Heebo',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
#map{width:100%;height:100%;position:absolute;top:0;left:0;z-index:1;background:#dfe6e0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPLASH / LOADING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.splash{
  position:fixed;inset:0;z-index:3000;
  background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  transition:opacity .7s cubic-bezier(.4,0,.2,1);
}
.splash.hidden{opacity:0;pointer-events:none}

.splash-logo{
  width:72px;height:72px;border-radius:18px;
  background:linear-gradient(145deg,#007aff 0%,#0055d4 100%);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 8px 32px rgba(0,122,255,0.25),0 2px 8px rgba(0,0,0,0.08);
  margin-bottom:20px;
  animation:splashPop .6s cubic-bezier(.34,1.56,.64,1) forwards;
  opacity:0;
}
@keyframes splashPop{
  0%{opacity:0;transform:scale(.5)}
  100%{opacity:1;transform:scale(1)}
}
.splash-logo svg{width:36px;height:36px;color:white}

.splash-title{
  font-family:'Secular One',sans-serif;
  font-size:28px;color:var(--text);letter-spacing:-.5px;
  margin-bottom:4px;
  animation:splashFade .6s .15s ease forwards;opacity:0;
}
.splash-sub{
  font-size:14px;color:var(--text3);font-weight:400;
  margin-bottom:32px;
  animation:splashFade .6s .25s ease forwards;opacity:0;
}
@keyframes splashFade{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}

.splash-spinner{
  width:32px;height:32px;border:3px solid var(--sep-heavy);
  border-top-color:var(--blue);border-radius:50%;
  animation:spin .8s linear infinite,splashFade .4s .35s ease forwards;opacity:0;
}
@keyframes spin{to{transform:rotate(360deg)}}

.splash-status{
  margin-top:16px;font-size:13px;color:var(--text4);font-weight:500;
  animation:splashFade .4s .4s ease forwards;opacity:0;
  transition:color .3s;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATUS BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar{
  position:fixed;top:0;left:0;right:0;z-index:1000;
  height:env(safe-area-inset-top,0px);min-height:54px;
  padding:env(safe-area-inset-top,8px) 16px 8px;
  display:flex;align-items:flex-end;justify-content:space-between;
  background:rgba(242,242,247,0.78);
  backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border-bottom:0.5px solid var(--sep);
  transition:all .35s ease;
}

.source-pill{
  display:flex;align-items:center;gap:8px;
  background:rgba(255,255,255,0.7);padding:6px 14px 6px 10px;
  border-radius:22px;border:0.5px solid var(--sep);
  box-shadow:var(--shadow-sm);
  transition:all .3s ease;
}
.source-pill.gps .pill-dot{background:var(--green);box-shadow:0 0 6px rgba(52,199,89,0.5)}
.source-pill.cell .pill-dot{background:var(--orange);box-shadow:0 0 6px rgba(255,149,0,0.5)}
.source-pill.none .pill-dot{background:var(--red);box-shadow:0 0 6px rgba(255,59,48,0.5)}

.pill-dot{width:8px;height:8px;border-radius:50%;transition:all .3s;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.55;transform:scale(.85)}}
.pill-label{font-size:13px;font-weight:600;color:var(--text2);white-space:nowrap}

.acc-chip{
  font-size:12px;font-weight:600;color:var(--text3);
  background:rgba(255,255,255,0.65);padding:6px 12px;
  border-radius:18px;border:0.5px solid var(--sep);
  box-shadow:var(--shadow-sm);
  transition:all .3s;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.search-area{position:fixed;top:62px;left:14px;right:14px;z-index:999}

.search-field{
  display:flex;align-items:center;gap:12px;
  background:var(--card);
  backdrop-filter:var(--blur-heavy);-webkit-backdrop-filter:var(--blur-heavy);
  border-radius:var(--radius);padding:0 18px;
  border:0.5px solid var(--sep);
  box-shadow:var(--shadow-md);
  transition:all .3s cubic-bezier(.4,0,.2,1);
}
.search-field:focus-within{
  box-shadow:var(--shadow-md),0 0 0 3px var(--blue-glow);
  border-color:rgba(0,122,255,0.3);
}
.search-field svg{flex-shrink:0;color:var(--text4);transition:color .2s}
.search-field:focus-within svg{color:var(--blue)}
.search-field input{
  flex:1;border:none;background:none;font-family:inherit;font-size:16px;
  padding:15px 0;outline:none;color:var(--text);direction:rtl;
  font-weight:500;
}
.search-field input::placeholder{color:var(--text4);font-weight:400}

.results-list{
  margin-top:8px;background:var(--card);
  backdrop-filter:var(--blur-heavy);-webkit-backdrop-filter:var(--blur-heavy);
  border-radius:var(--radius);border:0.5px solid var(--sep);
  box-shadow:var(--shadow-lg);
  max-height:240px;overflow-y:auto;
  display:none;
  -webkit-overflow-scrolling:touch;
  animation:resultsIn .2s ease;
}
.results-list.open{display:block}
@keyframes resultsIn{0%{opacity:0;transform:translateY(-4px)}100%{opacity:1;transform:translateY(0)}}

.result-row{
  padding:13px 18px;cursor:pointer;
  border-bottom:0.5px solid var(--sep);
  transition:background .12s;
  display:flex;align-items:center;gap:12px;
}
.result-row:active{background:rgba(0,122,255,0.05)}
.result-row:last-child{border:none}

.result-icon{
  width:34px;height:34px;border-radius:10px;
  background:var(--blue-light);
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.result-icon svg{width:16px;height:16px;color:var(--blue)}

.result-text{flex:1;min-width:0}
.result-name{font-size:15px;font-weight:600;color:var(--text);margin-bottom:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.result-addr{font-size:12px;color:var(--text3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDE CONTROLS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.side-controls{position:fixed;top:128px;left:14px;z-index:998;display:flex;flex-direction:column;gap:8px}
.ctrl-btn{
  width:48px;height:48px;border-radius:var(--radius-md);
  background:var(--card);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);
  border:0.5px solid var(--sep);
  display:flex;align-items:center;justify-content:center;cursor:pointer;
  box-shadow:var(--shadow-md);
  transition:all .2s cubic-bezier(.4,0,.2,1);
  -webkit-appearance:none;
}
.ctrl-btn:active{transform:scale(.88);background:var(--card-hover)}

.compass-svg{transition:transform .35s cubic-bezier(.4,0,.2,1)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM SHEET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sheet{
  position:fixed;bottom:0;left:0;right:0;z-index:999;
  background:var(--card);
  backdrop-filter:var(--blur-heavy);-webkit-backdrop-filter:var(--blur-heavy);
  border-radius:22px 22px 0 0;
  border-top:0.5px solid var(--sep);
  box-shadow:0 -4px 32px rgba(0,0,0,0.06);
  padding:6px 18px var(--safe-bottom);
  transition:transform .4s cubic-bezier(.32,.72,0,1);
}

.sheet-grip{
  width:36px;height:5px;border-radius:3px;
  background:rgba(0,0,0,0.1);margin:4px auto 14px;
}

/* Navigation Card */
.nav-panel{
  display:none;
  background:linear-gradient(135deg,rgba(0,122,255,0.06),rgba(0,122,255,0.02));
  border:1px solid rgba(0,122,255,0.12);
  border-radius:var(--radius);
  padding:16px 18px;margin-bottom:14px;
  position:relative;overflow:hidden;
}
.nav-panel::before{
  content:'';position:absolute;top:-30px;right:-30px;
  width:100px;height:100px;border-radius:50%;
  background:rgba(0,122,255,0.06);
}
.nav-panel.active{display:flex;justify-content:space-between;align-items:center;animation:navSlide .3s ease}
@keyframes navSlide{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}

.nav-label{font-size:12px;color:var(--text3);margin-bottom:4px;font-weight:500}
.nav-distance{font-size:34px;font-weight:900;color:var(--blue);line-height:1;letter-spacing:-1px}
.nav-bearing{font-size:13px;color:var(--text3);margin-top:5px;font-weight:500}

.nav-dismiss{
  width:32px;height:32px;border-radius:50%;
  background:rgba(0,0,0,0.05);border:none;
  font-size:16px;color:var(--text3);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;position:relative;z-index:2;
}
.nav-dismiss:active{background:rgba(0,0,0,0.1);transform:scale(.9)}

/* Metrics Strip */
.metrics{
  display:flex;gap:8px;margin-bottom:14px;
  overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;
  padding-bottom:2px;
}
.metrics::-webkit-scrollbar{display:none}

.metric-card{
  flex:1;min-width:74px;
  background:var(--bg);
  border-radius:var(--radius-md);
  padding:11px 8px;text-align:center;
  transition:all .25s;
}

.metric-label{
  font-size:9.5px;color:var(--text4);
  font-weight:700;text-transform:uppercase;letter-spacing:.5px;
  margin-bottom:5px;
}
.metric-value{
  font-size:22px;font-weight:800;color:var(--text);
  line-height:1.1;transition:color .3s;
}
.metric-unit{font-size:10px;color:var(--text3);margin-top:2px;font-weight:500}

/* Action Buttons */
.actions{display:flex;gap:10px}
.action-btn{
  flex:1;padding:15px;border-radius:var(--radius);border:none;
  font-family:inherit;font-size:15px;font-weight:700;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .2s cubic-bezier(.4,0,.2,1);
  -webkit-appearance:none;position:relative;overflow:hidden;
}
.action-btn:active{transform:scale(.96)}
.action-btn::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(180deg,rgba(255,255,255,0.15),transparent);
  pointer-events:none;
}

.btn-locate{background:var(--blue);color:white;box-shadow:0 4px 16px rgba(0,122,255,0.25)}
.btn-track{background:var(--card-solid);color:var(--text);border:0.5px solid var(--sep);box-shadow:var(--shadow-sm)}
.btn-tracking{background:var(--green);color:white;box-shadow:0 4px 16px rgba(52,199,89,0.25)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CREDIT FOOTER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.credit-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:1001;
  pointer-events:none;
  display:flex;justify-content:center;
  padding-bottom:calc(var(--safe-bottom) + 2px);
}
.credit-tag{
  pointer-events:auto;
  background:rgba(0,0,0,0.55);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  padding:5px 14px;border-radius:20px;
  font-size:10.5px;font-weight:600;color:rgba(255,255,255,0.85);
  letter-spacing:.2px;
  box-shadow:0 2px 12px rgba(0,0,0,0.15);
  display:flex;align-items:center;gap:5px;
}
.credit-tag .dot{
  width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.4);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{
  position:fixed;top:68px;left:50%;z-index:1100;
  transform:translateX(-50%) translateY(-100px);
  background:var(--card-solid);border-radius:var(--radius-md);
  padding:11px 22px;font-size:14px;font-weight:600;color:var(--text);
  box-shadow:var(--shadow-lg);border:0.5px solid var(--sep);
  transition:transform .45s cubic-bezier(.34,1.56,.64,1);
  white-space:nowrap;max-width:92%;
  display:flex;align-items:center;gap:8px;
}
.toast.show{transform:translateX(-50%) translateY(0)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEAFLET OVERRIDES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.leaflet-control-zoom{display:none!important}
.leaflet-control-attribution{
  background:rgba(242,242,247,0.8)!important;
  backdrop-filter:blur(8px)!important;-webkit-backdrop-filter:blur(8px)!important;
  font-size:9px!important;padding:3px 7px!important;
  border-radius:8px 0 0 0!important;
  border-top:0.5px solid var(--sep)!important;
  border-left:0.5px solid var(--sep)!important;
}
.leaflet-control-attribution a{color:var(--text3)!important;text-decoration:none!important}
</style>
</head>
<body>

<!-- â•â•â• Splash â•â•â• -->
<div class="splash" id="splash">
  <div class="splash-logo">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="3,11 22,2 13,21 11,13"/>
    </svg>
  </div>
  <div class="splash-title">NavGuard</div>
  <div class="splash-sub">× ×™×•×•×˜ ×—×™×¨×•× Â· ××™×§×•× ×¨×‘-××§×•×¨×•×ª</div>
  <div class="splash-spinner"></div>
  <div class="splash-status" id="splashStatus">×˜×•×¢×Ÿ ××¤×”...</div>
</div>

<!-- â•â•â• Toast â•â•â• -->
<div class="toast" id="toast"></div>

<!-- â•â•â• Top Bar â•â•â• -->
<div class="topbar">
  <div class="source-pill" id="sourcePill">
    <div class="pill-dot" id="pillDot"></div>
    <span class="pill-label" id="pillLabel">××—×¤×© ××™×§×•×...</span>
  </div>
  <div class="acc-chip" id="accChip">â€”</div>
</div>

<!-- â•â•â• Search â•â•â• -->
<div class="search-area">
  <div class="search-field">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" id="searchInput" placeholder="×—×¤×© ×™×¢×“ â€” ×›×ª×•×‘×ª, ×¢×™×¨, ××§×•×" autocomplete="off" spellcheck="false">
  </div>
  <div class="results-list" id="resultsList"></div>
</div>

<!-- â•â•â• Side â•â•â• -->
<div class="side-controls">
  <div class="ctrl-btn" id="compassBtn" role="button" aria-label="××¦×¤×Ÿ">
    <svg class="compass-svg" id="compassSvg" width="22" height="22" viewBox="0 0 40 40">
      <polygon points="20,4 24.5,20 20,17 15.5,20" fill="#ff3b30"/>
      <polygon points="20,36 15.5,20 20,23 24.5,20" fill="#c7c7cc"/>
    </svg>
  </div>
  <div class="ctrl-btn" id="recenterBtn" role="button" aria-label="××¨×›×– ××™×§×•×">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007aff" stroke-width="2.5" stroke-linecap="round">
      <circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/>
    </svg>
  </div>
</div>

<!-- â•â•â• Map â•â•â• -->
<div id="map"></div>

<!-- â•â•â• Bottom Sheet â•â•â• -->
<div class="sheet">
  <div class="sheet-grip"></div>

  <div class="nav-panel" id="navPanel">
    <div>
      <div class="nav-label" id="navLabel">× ×™×•×•×˜ ×œ:</div>
      <div class="nav-distance" id="navDistance">â€”</div>
      <div class="nav-bearing" id="navBearing">â€”</div>
    </div>
    <button class="nav-dismiss" id="navDismiss" aria-label="×¡×’×•×¨ × ×™×•×•×˜">âœ•</button>
  </div>

  <div class="metrics">
    <div class="metric-card">
      <div class="metric-label">××§×•×¨</div>
      <div class="metric-value" id="mSrc" style="font-size:14px">â€”</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">×“×™×•×§</div>
      <div class="metric-value" id="mAcc">â€”</div>
      <div class="metric-unit">××˜×¨</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">××”×™×¨×•×ª</div>
      <div class="metric-value" id="mSpd">â€”</div>
      <div class="metric-unit">×§××´×©</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">×›×™×•×•×Ÿ</div>
      <div class="metric-value" id="mHdg" style="font-size:14px">â€”</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">×’×•×‘×”</div>
      <div class="metric-value" id="mAlt">â€”</div>
      <div class="metric-unit">××˜×¨</div>
    </div>
  </div>

  <div class="actions">
    <button class="action-btn btn-locate" id="btnLocate">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/></svg>
      ××ª×¨ ××™×§×•×
    </button>
    <button class="action-btn btn-track" id="btnTrack">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polygon points="3,11 22,2 13,21 11,13"/></svg>
      ××¢×§×‘ ×¨×¦×™×£
    </button>
  </div>
</div>

<!-- â•â•â• Credit â•â•â• -->
<div class="credit-bar">
  <div class="credit-tag">
    ×›×œ×™ × ×™×¡×™×•× ×™
    <span class="dot"></span>
    ×¤×•×ª×— ×¢×´×™ ×¨×•×¢×™ ×¦×•×§×¨××Ÿ
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCRIPTS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// CDN fallback loader
function loadScript(src){
  return new Promise((ok,fail)=>{
    const s=document.createElement('script');s.src=src;s.crossOrigin='';
    s.onload=ok;s.onerror=fail;document.head.appendChild(s);
  });
}

async function boot(){
  const st=document.getElementById('splashStatus');
  const cdns=[
    'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
    'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js',
    'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js'
  ];
  let ok=typeof L!=='undefined';
  if(!ok){
    for(const u of cdns){
      try{st.textContent='×˜×•×¢×Ÿ ×¡×¤×¨×™×™×ª ××¤×•×ª...';await loadScript(u);ok=true;break}
      catch(e){console.warn('CDN fail:',u)}
    }
  }
  if(!ok){st.textContent='×©×’×™××” ×‘×˜×¢×™× ×ª ××¤×•×ª â€” ×‘×“×•×§ ××™× ×˜×¨× ×˜';st.style.color='#ff3b30';return}
  st.textContent='×××ª×—×œ...';
  App.init();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const App={
  map:null,uMark:null,accRing:null,routeLine:null,destMark:null,
  wId:null,fbW:null,tracking:false,pos:null,heading:null,
  dest:null,hist:[],sTmr:null,ready:false,firstFix:false,

  init(){
    try{
      this.buildMap();
      this.sensors();
      this.events();
      this.map.whenReady(()=>{
        this.ready=true;
        document.getElementById('splashStatus').textContent='×××ª×¨ ××™×§×•×...';
        this.locate();
      });
    }catch(e){
      console.error(e);
      document.getElementById('splashStatus').textContent='×©×’×™××”: '+e.message;
    }
  },

  /* â”€â”€ Map â”€â”€ */
  buildMap(){
    this.map=L.map('map',{zoomControl:false,attributionControl:true,center:[31.77,35.21],zoom:8});

    const tiles=[
      ['https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png','CARTO'],
      ['https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png','OSM'],
      ['https://tile.openstreetmap.org/{z}/{x}/{y}.png','OSM2']
    ];
    let layer=null,errs=0;
    const tryIdx=(i)=>{
      if(i>=tiles.length)return;
      if(layer)this.map.removeLayer(layer);
      errs=0;
      layer=L.tileLayer(tiles[i][0],{maxZoom:19,crossOrigin:true,attribution:'&copy; '+tiles[i][1]});
      layer.on('tileerror',()=>{errs++;if(errs>4&&i<tiles.length-1){console.warn('tiles fail, next');tryIdx(i+1)}});
      layer.addTo(this.map);
    };
    tryIdx(0);

    setTimeout(()=>this.map.invalidateSize(),150);
    setTimeout(()=>this.map.invalidateSize(),600);

    // User marker
    const mHtml=`
      <div style="position:relative;width:28px;height:28px">
        <div style="position:absolute;inset:-6px;border-radius:50%;background:rgba(0,122,255,.1);animation:uRing 2.2s ease-out infinite"></div>
        <div id="uDir" style="position:absolute;top:-14px;left:50%;transform:translateX(-50%);
          width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;
          border-bottom:14px solid #007aff;z-index:3;display:none;
          filter:drop-shadow(0 1px 3px rgba(0,0,0,.12));transition:transform .3s"></div>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
          width:20px;height:20px;border-radius:50%;
          background:linear-gradient(180deg,#1a8fff,#0066e0);
          border:3.5px solid white;
          box-shadow:0 2px 10px rgba(0,122,255,.4),0 0 0 1px rgba(0,122,255,.1);z-index:2"></div>
      </div>
      <style>@keyframes uRing{0%{transform:scale(.6);opacity:.7}100%{transform:scale(2.5);opacity:0}}</style>`;
    this.uMark=L.marker([0,0],{icon:L.divIcon({html:mHtml,className:'',iconSize:[28,28],iconAnchor:[14,14]}),zIndexOffset:1000});
    this.accRing=L.circle([0,0],{radius:0,color:'#007aff',fillColor:'rgba(0,122,255,0.07)',weight:1.5,opacity:.45,fillOpacity:.07});
  },

  /* â”€â”€ Sensors â”€â”€ */
  sensors(){
    const go=()=>window.addEventListener('deviceorientation',e=>{
      let h=e.webkitCompassHeading!==undefined?e.webkitCompassHeading:e.alpha!==null?(360-e.alpha)%360:null;
      if(h!==null){this.heading=h;this.compass(h)}
    },true);
    if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
      document.addEventListener('click',()=>DeviceOrientationEvent.requestPermission().then(s=>{if(s==='granted')go()}).catch(()=>{}),{once:true});
    }else go();
  },

  compass(h){
    const c=document.getElementById('compassSvg');if(c)c.style.transform=`rotate(${h}deg)`;
    const a=document.getElementById('uDir');if(a){a.style.display='block';a.style.transform=`translateX(-50%) rotate(${h}deg)`}
  },

  /* â”€â”€ Geolocation â”€â”€ */
  locate(){
    if(!navigator.geolocation){this.toast('âš ï¸ ×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘××™×§×•×');this.hideSplash();return}
    navigator.geolocation.getCurrentPosition(p=>this.onPos(p),err=>{
      console.warn('Hi-acc fail:',err.message);
      navigator.geolocation.getCurrentPosition(p=>this.onPos(p),err2=>{
        console.warn('Lo-acc fail:',err2.message);
        this.hideSplash();this.toast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ××ª×¨ ××™×§×•× â€” ×•×“× ×©×”××™×§×•× ××•×¤×¢×œ');
        this.setSource('××™×Ÿ ××™×§×•×','none');
      },{enableHighAccuracy:false,timeout:20000,maximumAge:300000});
    },{enableHighAccuracy:true,timeout:15000,maximumAge:0});
    navigator.geolocation.getCurrentPosition(p=>{if(!this.pos)this.onPos(p)},()=>{},{enableHighAccuracy:false,timeout:10000,maximumAge:60000});
  },

  startTrack(){
    if(this.tracking){this.stopTrack();return}
    this.tracking=true;
    const b=document.getElementById('btnTrack');
    b.className='action-btn btn-tracking';
    b.innerHTML='<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>×¢×¦×•×¨ ××¢×§×‘';
    this.wId=navigator.geolocation.watchPosition(p=>this.onPos(p),()=>{this.toast('âš ï¸ GPS ××•×¤×¨×¢ â€” ××©×ª××© ×‘×—×œ×•×¤×™')},{enableHighAccuracy:true,timeout:10000,maximumAge:2000});
    this.fbW=navigator.geolocation.watchPosition(p=>{if(!this.pos||p.coords.accuracy<this.pos.acc*1.5+100)this.onPos(p)},()=>{},{enableHighAccuracy:false,timeout:30000,maximumAge:10000});
    this.toast('ğŸ“¡ ××¢×§×‘ ××™×§×•× ×¤×¢×™×œ');
  },

  stopTrack(){
    this.tracking=false;
    if(this.wId!==null){navigator.geolocation.clearWatch(this.wId);this.wId=null}
    if(this.fbW!==null){navigator.geolocation.clearWatch(this.fbW);this.fbW=null}
    const b=document.getElementById('btnTrack');
    b.className='action-btn btn-track';
    b.innerHTML='<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polygon points="3,11 22,2 13,21 11,13"/></svg>××¢×§×‘ ×¨×¦×™×£';
    this.toast('××¢×§×‘ ×”×•×¤×¡×§');
  },

  onPos(p){
    const{latitude:lat,longitude:lng,accuracy:acc,speed:spd,heading:hdg,altitude:alt}=p.coords;
    const src=this.classify(acc);
    this.pos={lat,lng,acc,spd,hdg,alt,src,t:Date.now()};
    this.hist.push({...this.pos});if(this.hist.length>120)this.hist.shift();
    this.render();this.hideSplash();
  },

  classify(a){
    if(a<=15)return{n:'GPS',c:'gps',clr:'green'};
    if(a<=40)return{n:'GPS/WiFi',c:'gps',clr:'green'};
    if(a<=150)return{n:'WiFi',c:'cell',clr:'orange'};
    if(a<=800)return{n:'×¡×œ×•×œ×¨×™',c:'cell',clr:'orange'};
    return{n:'×¡×œ×•×œ×¨×™ (××©×•×¢×¨)',c:'none',clr:'red'};
  },

  /* â”€â”€ Render â”€â”€ */
  render(){
    if(!this.pos||!this.ready)return;
    const{lat,lng,acc,spd,hdg,alt,src}=this.pos;

    this.uMark.setLatLng([lat,lng]).addTo(this.map);
    this.accRing.setLatLng([lat,lng]).setRadius(acc).addTo(this.map);

    if(!this.firstFix){
      this.firstFix=true;
      this.map.flyTo([lat,lng],acc<80?16:acc<400?14:12,{duration:1.3});
    }

    this.setSource(src.n+' ×¤×¢×™×œ',src.c);
    document.getElementById('accChip').textContent=`Â±${Math.round(acc)}m`;

    const ms=document.getElementById('mSrc');
    ms.textContent=src.n;
    ms.style.color=src.clr==='green'?'var(--green)':src.clr==='orange'?'var(--orange)':'var(--red)';

    const ma=document.getElementById('mAcc');
    ma.textContent=Math.round(acc);
    ma.style.color=acc<50?'var(--green)':acc<200?'var(--orange)':'var(--red)';

    if(spd!==null&&spd>=0)document.getElementById('mSpd').textContent=Math.round(spd*3.6);
    const h=hdg!==null?hdg:this.heading;
    if(h!==null)document.getElementById('mHdg').textContent=this.heb(h);
    if(alt!==null)document.getElementById('mAlt').textContent=Math.round(alt);
    if(this.dest)this.renderNav();
  },

  setSource(txt,cls){
    document.getElementById('pillLabel').textContent=txt;
    const pill=document.getElementById('sourcePill');
    pill.className='source-pill '+cls;
  },

  heb(h){
    const dirs=['×¦×¤×•×Ÿ','×¦×¤×•×Ÿ-××–×¨×—','××–×¨×—','×“×¨×•×-××–×¨×—','×“×¨×•×','×“×¨×•×-××¢×¨×‘','××¢×¨×‘','×¦×¤×•×Ÿ-××¢×¨×‘'];
    return dirs[Math.round(h/45)%8];
  },

  /* â”€â”€ Search â”€â”€ */
  async search(q){
    if(!q||q.length<2){document.getElementById('resultsList').classList.remove('open');return}
    try{
      const r=await(await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=il&limit=5&accept-language=he`)).json();
      const c=document.getElementById('resultsList');c.innerHTML='';
      if(!r.length){
        c.innerHTML=`<div class="result-row"><div class="result-text"><div class="result-name">×œ× × ××¦××• ×ª×•×¦××•×ª</div></div></div>`;
        c.classList.add('open');return;
      }
      r.forEach(i=>{
        const nm=i.display_name.split(',')[0];
        const ad=i.display_name.split(',').slice(1,3).join(', ');
        const d=document.createElement('div');d.className='result-row';
        d.innerHTML=`
          <div class="result-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
          <div class="result-text"><div class="result-name">${nm}</div><div class="result-addr">${ad}</div></div>`;
        d.onclick=()=>{this.setDest(+i.lat,+i.lon,nm);c.classList.remove('open');document.getElementById('searchInput').value=nm};
        c.appendChild(d);
      });
      c.classList.add('open');
    }catch(e){this.toast('âš ï¸ ×©×’×™××” ×‘×—×™×¤×•×©')}
  },

  /* â”€â”€ Navigation â”€â”€ */
  setDest(lat,lng,name){
    this.dest={lat,lng,name};
    if(this.destMark)this.map.removeLayer(this.destMark);
    this.destMark=L.marker([lat,lng],{icon:L.divIcon({
      html:`<div style="position:relative">
        <div style="width:14px;height:14px;border-radius:50%;background:var(--blue);border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,.2)"></div>
        <div style="position:absolute;top:-28px;left:50%;transform:translateX(-50%);background:var(--blue);color:white;padding:3px 10px;border-radius:8px;font-size:12px;font-weight:700;font-family:Heebo,sans-serif;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.15)">${name}</div>
        <div style="position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:6px solid var(--blue)"></div>
      </div>`,
      className:'',iconSize:[14,14],iconAnchor:[7,7]
    })}).addTo(this.map);
    if(this.pos)this.map.fitBounds([[this.pos.lat,this.pos.lng],[lat,lng]],{padding:[100,120]});
    else this.map.flyTo([lat,lng],14);
    document.getElementById('navPanel').classList.add('active');
    document.getElementById('navLabel').textContent='× ×™×•×•×˜ ×œ: '+name;
    this.renderNav();
  },

  renderNav(){
    if(!this.pos||!this.dest)return;
    const d=this.dist(this.pos.lat,this.pos.lng,this.dest.lat,this.dest.lng);
    const b=this.bear(this.pos.lat,this.pos.lng,this.dest.lat,this.dest.lng);
    document.getElementById('navDistance').textContent=d<1000?Math.round(d)+' ××˜×¨':(d/1000).toFixed(1)+' ×§×´×';
    document.getElementById('navBearing').textContent='×›×™×•×•×Ÿ: '+this.heb(b)+' Â· '+Math.round(b)+'Â°';
    if(this.routeLine)this.map.removeLayer(this.routeLine);
    this.routeLine=L.polyline([[this.pos.lat,this.pos.lng],[this.dest.lat,this.dest.lng]],
      {color:'#007aff',weight:4,opacity:.5,dashArray:'10,8',lineCap:'round'}).addTo(this.map);
  },

  clearNav(){
    this.dest=null;
    if(this.destMark){this.map.removeLayer(this.destMark);this.destMark=null}
    if(this.routeLine){this.map.removeLayer(this.routeLine);this.routeLine=null}
    document.getElementById('navPanel').classList.remove('active');
    document.getElementById('searchInput').value='';
  },

  /* â”€â”€ Math â”€â”€ */
  dist(a,b,c,d){const R=6371000,p=Math.PI/180,dl=(c-a)*p,dn=(d-b)*p,x=Math.sin(dl/2)**2+Math.cos(a*p)*Math.cos(c*p)*Math.sin(dn/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))},
  bear(a,b,c,d){const p=Math.PI/180,y=Math.sin((d-b)*p)*Math.cos(c*p),x=Math.cos(a*p)*Math.sin(c*p)-Math.sin(a*p)*Math.cos(c*p)*Math.cos((d-b)*p);return(Math.atan2(y,x)*180/Math.PI+360)%360},

  /* â”€â”€ Utils â”€â”€ */
  toast(m){const t=document.getElementById('toast');t.textContent=m;t.className='toast show';clearTimeout(this._tt);this._tt=setTimeout(()=>t.classList.remove('show'),3500)},
  hideSplash(){document.getElementById('splash').classList.add('hidden')},
  recenter(){if(this.pos&&this.ready)this.map.flyTo([this.pos.lat,this.pos.lng],16,{duration:.6})},

  /* â”€â”€ Events â”€â”€ */
  events(){
    document.getElementById('btnLocate').onclick=()=>this.locate();
    document.getElementById('btnTrack').onclick=()=>this.startTrack();
    document.getElementById('recenterBtn').onclick=()=>this.recenter();
    document.getElementById('navDismiss').onclick=()=>this.clearNav();
    const si=document.getElementById('searchInput');
    si.oninput=e=>{clearTimeout(this.sTmr);this.sTmr=setTimeout(()=>this.search(e.target.value),350)};
    document.addEventListener('click',e=>{if(!e.target.closest('.search-area'))document.getElementById('resultsList').classList.remove('open')});
    window.addEventListener('resize',()=>{if(this.map)setTimeout(()=>this.map.invalidateSize(),120)});
  }
};

document.addEventListener('DOMContentLoaded',boot);
</script>
</body>
</html>
